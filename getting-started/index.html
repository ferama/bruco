<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.83.1"><meta name=viewport content="width=device-width,initial-scale=1"><title>Getting started on k8s &#183; Bruco üêõ</title><meta name=description content><link type=text/css rel=stylesheet href=https://ferama.github.io/bruco/css/print.css media=print><link type=text/css rel=stylesheet href=https://ferama.github.io/bruco/css/poole.css><link type=text/css rel=stylesheet href=https://ferama.github.io/bruco/css/syntax.css><link type=text/css rel=stylesheet href=https://ferama.github.io/bruco/css/hyde.css><link type=text/css rel=stylesheet href=https://ferama.github.io/bruco/css/overrides.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://ferama.github.io/bruco/><h1>Bruco üêõ</h1></a><p class=lead>Easy build streaming pipelines. Handle business logic in python</p></div><nav><ul class=sidebar-nav><li><a href=https://ferama.github.io/bruco/>Home</a></li><li><a href=/bruco/getting-started>Getting started on k8s</a></li><li><a href=/bruco/config-file>Config</a></li><ul><li><a href=/bruco/sources>Sources</a></li><li><a href=/bruco/sinks>Sinks</a></li><li><a href=/bruco/processor>Processor</a></li></ul><li><a href=https://github.com/ferama/bruco><i class="fab fa-github"></i> Star Bruco on Github</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Getting started on k8s</h1><p>This guide will introduce you to the <strong>bruco</strong> concept e will help to get the stuff up and running quickly.</p><p>This tutorial make some assumptions:</p><ol><li>You have a kubernetes environment up and running</li><li>You have correctly configured the <strong>kubectl</strong> cli tool to interact with the env above</li></ol><p>Bruco is heavily integrated with Kubernetes. To get start to experiment with bruco function deployment you need to setup some stuff on kubernetes first.</p><p>Bruco defines a custom resource for its functions. The resource is called guess that, bruco üôÇ</p><p>This is a sample resource instance that you will able to create:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>brucocontroller.ferama.github.com/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Bruco</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>example-bruco</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>functionURL</span>: <span style=color:#ae81ff>https://github.com/ferama/bruco/raw/main/hack/examples/zipped/sentiment.zip</span>
</code></pre></div><p>but before that, you need to create the custom resource definition on k8s and to deploy the controller supporting the custom resource.</p><p>Follow this steps to do that.</p><h2 id=k8s-controller-deployment>k8s controller deployment</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># create a new k8s namespace for bruco</span>
$ kubectl create ns bruco

<span style=color:#75715e># create the custom resource</span>
$ kubectl -n bruco apply -f https://raw.githubusercontent.com/ferama/bruco/main/hack/k8s/resources/crd-bruco.yaml

<span style=color:#75715e># deploy the bruco controller</span>
$ kubectl -n bruco apply -f https://raw.githubusercontent.com/ferama/bruco/main/hack/k8s/resources/controller.yaml
</code></pre></div><p>The result should be something like this, that means that the bruco controller is up and running:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl -n bruco get pods
NAME                               READY   STATUS    RESTARTS   AGE
bruco-controller-5fd955d49-7p6xt   1/1     Running   <span style=color:#ae81ff>0</span>          37s
</code></pre></div><h2 id=demo-function-deployment>demo function deployment</h2><p>Now you are ready to deploy your first bruco function. Create a file named <strong>example-bruco.yaml</strong> and copy and paste the example bruco function definition:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>brucocontroller.ferama.github.com/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Bruco</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>example-bruco</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>functionURL</span>: <span style=color:#ae81ff>https://github.com/ferama/bruco/raw/main/hack/examples/zipped/sentiment.zip</span>
</code></pre></div><p>Create the kubernetes resource using:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl -n bruco apply -f example-bruco.yaml
</code></pre></div><p>What is happening here, is that bruco will load the package at <code>https://github.com/ferama/bruco/raw/main/hack/examples/zipped/sentiment.zip</code> and starts a deployment with one replicas that will run the <strong>sentiment</strong> function. The zip file contains all the required config and logic to run the function. In this example the zip file contains:</p><ol><li>A bruco <code>config.yaml</code> file</li><li>An <code>handler.py</code> with the function logic</li><li>A <code>requirements.txt</code> file that declares the funcion dependencies</li></ol><p>The <code>config.yaml</code> file contains the bruco function config about source, sink and processor. For this example it is very simple:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>processor</span>:
  <span style=color:#f92672>handlerPath</span>: <span style=color:#ae81ff>.</span>
  <span style=color:#f92672>moduleName</span>: <span style=color:#ae81ff>handler</span>
  <span style=color:#f92672>workers</span>: <span style=color:#ae81ff>2</span>

<span style=color:#f92672>source</span>:
  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>http</span>
</code></pre></div><p>The handler is a very simple python function:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> textblob <span style=color:#f92672>import</span> TextBlob

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_event</span>(context, data):
    blob <span style=color:#f92672>=</span> TextBlob(data<span style=color:#f92672>.</span>decode())
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#34;sentiment&#34;</span>: blob<span style=color:#f92672>.</span>sentiment<span style=color:#f92672>.</span>polarity,
        <span style=color:#e6db74>&#34;subjectivity&#34;</span>: blob<span style=color:#f92672>.</span>sentiment<span style=color:#f92672>.</span>subjectivity
    }
</code></pre></div><p>The handler function requires the <code>textblob</code> library. The dependency is defined in the <code>requirements.txt</code> file</p><pre><code>textblob
</code></pre><p>Now you are ready to test out your first bruco function. Let&rsquo;s forward the <code>http source</code> port:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># forwards the http source port</span>
$ kubectl -n bruco port-forward svc/example-bruco <span style=color:#ae81ff>8080</span>
<span style=color:#75715e># generate an event using the http source</span>
$ curl -X POST -d <span style=color:#e6db74>&#34;bruco is great&#34;</span> http://localhost:8080
<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;sentiment&#34;</span>: 0.8, <span style=color:#e6db74>&#34;subjectivity&#34;</span>: 0.75<span style=color:#f92672>}</span>
</code></pre></div></div></main></body></html>